name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  FLUTTER_VERSION: '3.24.0'
  JAVA_VERSION: '17'

jobs:
  # ===== Job 1: OpenAPI Validation =====
  openapi-validation:
    name: Validate OpenAPI Specification
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install OpenAPI Generator CLI
        run: npm install -g @openapitools/openapi-generator-cli

      - name: Validate OpenAPI Syntax
        run: |
          openapi-generator-cli validate -i openapi/urbanbloom-api-v1.yaml

      - name: Generate Spring Boot Server Stubs
        run: |
          openapi-generator-cli generate \
            -i openapi/urbanbloom-api-v1.yaml \
            -g spring \
            -o generated/server \
            --additional-properties=interfaceOnly=true,useSpringBoot3=true
        continue-on-error: false

      - name: Generate Dart Client SDK
        run: |
          openapi-generator-cli generate \
            -i openapi/urbanbloom-api-v1.yaml \
            -g dart \
            -o generated/dart-client \
            --additional-properties=pubName=urbanbloom_api_client
        continue-on-error: false

      - name: Upload Generated SDKs
        uses: actions/upload-artifact@v4
        with:
          name: generated-sdks
          path: generated/
          retention-days: 7

  # ===== Job 2: Backend Build & Test =====
  backend-build:
    name: Backend - Build & Test
    runs-on: ubuntu-latest
    needs: openapi-validation
    defaults:
      run:
        working-directory: server

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Check if server project exists
        id: check_server
        run: |
          if [ -f "pom.xml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Server project not initialized yet. Run scripts/init-server.sh"
          fi

      - name: Maven Clean Install
        if: steps.check_server.outputs.exists == 'true'
        run: mvn clean install -DskipTests

      - name: Run Unit Tests
        if: steps.check_server.outputs.exists == 'true'
        run: mvn test

      - name: Run Integration Tests
        if: steps.check_server.outputs.exists == 'true'
        run: mvn verify -P integration-tests
        continue-on-error: true  # May not exist yet

      - name: Generate Test Coverage Report
        if: steps.check_server.outputs.exists == 'true'
        run: mvn jacoco:report

      - name: Check Code Coverage (70% minimum)
        if: steps.check_server.outputs.exists == 'true'
        run: mvn jacoco:check
        continue-on-error: true  # Warning only, don't fail build

      - name: Run SpotBugs Security Analysis
        if: steps.check_server.outputs.exists == 'true'
        run: mvn spotbugs:check
        continue-on-error: true  # May not be configured yet

      - name: Upload Test Results
        if: steps.check_server.outputs.exists == 'true' && always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results
          path: server/target/surefire-reports/

      - name: Upload Coverage Report
        if: steps.check_server.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-report
          path: server/target/site/jacoco/

  # ===== Job 3: Mobile Build & Test =====
  mobile-build:
    name: Mobile - Build & Test
    runs-on: ubuntu-latest
    needs: openapi-validation
    defaults:
      run:
        working-directory: mobile

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Check if mobile project exists
        id: check_mobile
        run: |
          if [ -f "pubspec.yaml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Mobile project not initialized yet. Run scripts/init-mobile.sh"
          fi

      - name: Get Dependencies
        if: steps.check_mobile.outputs.exists == 'true'
        run: flutter pub get

      - name: Run Code Generation (build_runner)
        if: steps.check_mobile.outputs.exists == 'true'
        run: flutter pub run build_runner build --delete-conflicting-outputs
        continue-on-error: true  # May not be configured yet

      - name: Analyze Code (Linting)
        if: steps.check_mobile.outputs.exists == 'true'
        run: flutter analyze

      - name: Check Formatting
        if: steps.check_mobile.outputs.exists == 'true'
        run: flutter format --set-exit-if-changed .
        continue-on-error: true  # Warning only

      - name: Run Unit & Widget Tests
        if: steps.check_mobile.outputs.exists == 'true'
        run: flutter test --coverage

      - name: Upload Test Coverage
        if: steps.check_mobile.outputs.exists == 'true'
        uses: codecov/codecov-action@v4
        with:
          files: mobile/coverage/lcov.info
          flags: mobile
        continue-on-error: true  # May not have Codecov configured

      - name: Build APK (Android)
        if: steps.check_mobile.outputs.exists == 'true'
        run: flutter build apk --debug

      - name: Upload APK Artifact
        if: steps.check_mobile.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: mobile-apk
          path: mobile/build/app/outputs/flutter-apk/app-debug.apk

  # ===== Job 4: Web Admin Build & Test =====
  web-admin-build:
    name: Web Admin - Build & Test
    runs-on: ubuntu-latest
    needs: openapi-validation
    defaults:
      run:
        working-directory: admin-web

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Check if admin-web project exists
        id: check_web
        run: |
          if [ -f "pubspec.yaml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Admin web project not initialized yet. Run scripts/init-web-admin.sh"
          fi

      - name: Get Dependencies
        if: steps.check_web.outputs.exists == 'true'
        run: flutter pub get

      - name: Run Code Generation (build_runner)
        if: steps.check_web.outputs.exists == 'true'
        run: flutter pub run build_runner build --delete-conflicting-outputs
        continue-on-error: true

      - name: Analyze Code (Linting)
        if: steps.check_web.outputs.exists == 'true'
        run: flutter analyze

      - name: Check Formatting
        if: steps.check_web.outputs.exists == 'true'
        run: flutter format --set-exit-if-changed .
        continue-on-error: true

      - name: Run Unit & Widget Tests
        if: steps.check_web.outputs.exists == 'true'
        run: flutter test --coverage

      - name: Build Web Bundle
        if: steps.check_web.outputs.exists == 'true'
        run: flutter build web --release

      - name: Upload Web Build Artifact
        if: steps.check_web.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: web-admin-build
          path: admin-web/build/web/

  # ===== Job 5: API Compliance Tests (Backend) =====
  api-compliance:
    name: API Compliance Tests
    runs-on: ubuntu-latest
    needs: [openapi-validation, backend-build]
    if: needs.backend-build.result != 'skipped'
    defaults:
      run:
        working-directory: server

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Download Generated Server Stubs
        uses: actions/download-artifact@v4
        with:
          name: generated-sdks
          path: generated/

      - name: Run API Compliance Tests
        run: |
          # This would run custom tests that compare implemented endpoints with OpenAPI spec
          # using springdoc-openapi-maven-plugin or similar
          echo "‚ö†Ô∏è API compliance tests not yet implemented"
          echo "TODO: Add springdoc-openapi integration tests"
        continue-on-error: true

  # ===== Job 6: PR Comment with Results =====
  pr-comment:
    name: Comment on PR with Results
    runs-on: ubuntu-latest
    needs: [openapi-validation, backend-build, mobile-build, web-admin-build]
    if: github.event_name == 'pull_request' && always()
    permissions:
      pull-requests: write

    steps:
      - name: Generate PR Comment
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = {
              'OpenAPI Validation': '${{ needs.openapi-validation.result }}',
              'Backend Build': '${{ needs.backend-build.result }}',
              'Mobile Build': '${{ needs.mobile-build.result }}',
              'Web Admin Build': '${{ needs.web-admin-build.result }}'
            };

            const statusEmoji = {
              'success': '‚úÖ',
              'failure': '‚ùå',
              'skipped': '‚è≠Ô∏è',
              'cancelled': 'üö´'
            };

            let comment = '## CI Pipeline Results\n\n';
            for (const [job, result] of Object.entries(jobs)) {
              comment += `${statusEmoji[result] || '‚ùì'} **${job}**: ${result}\n`;
            }

            comment += '\n---\n';
            comment += 'View [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ===== Job 7: Slack/Discord Notification (Optional) =====
  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [backend-build, mobile-build, web-admin-build]
    if: failure() && github.ref == 'refs/heads/main'

    steps:
      - name: Send Notification
        run: |
          echo "‚ö†Ô∏è CI Pipeline failed on main branch!"
          echo "Configure Slack/Discord webhook in repository secrets for notifications"
          # Uncomment and configure webhook URL:
          # curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
          #   -H 'Content-Type: application/json' \
          #   -d '{"text": "CI Pipeline failed on main! Check: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}'
